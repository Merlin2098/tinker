# System Configuration Schema
# Schema for inspector-generated system configuration

$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "system_config.schema.yaml"
title: "System Configuration"
description: "Schema for inspector-generated system configuration files"
type: object

required:
  - config_id
  - version
  - created_at
  - system_definitions
  - workflow_configuration

additionalProperties: false

properties:
  config_id:
    type: string
    format: uuid
    description: "Unique identifier for this configuration"

  version:
    type: string
    pattern: "^\\d+\\.\\d+\\.\\d+$"
    description: "Configuration schema version"

  created_at:
    type: string
    format: date-time
    description: "ISO-8601 timestamp of creation"

  plan_reference:
    type: string
    format: uuid
    description: "Reference to associated task plan"

  system_definitions:
    type: object
    description: "System component definitions"
    required:
      - target_components
    additionalProperties: false
    properties:
      target_components:
        type: array
        minItems: 1
        items:
          type: object
          required:
            - component_id
            - component_type
            - file_paths
          additionalProperties: false
          properties:
            component_id:
              type: string
              pattern: "^[a-z][a-z0-9_]*$"
              description: "Unique component identifier"
            component_type:
              type: string
              enum:
                - etl_module
                - ui_component
                - utility
                - schema
                - query
                - pipeline
                - configuration
              description: "Type of component"
            file_paths:
              type: array
              items:
                type: string
              description: "Files belonging to this component"
            description:
              type: string
              description: "Component description"

      affected_modules:
        type: array
        items:
          type: string
        description: "Modules affected by the task"

      dependencies:
        type: array
        items:
          type: object
          required:
            - from
            - to
            - type
          additionalProperties: false
          properties:
            from:
              type: string
              description: "Source component"
            to:
              type: string
              description: "Target component"
            type:
              type: string
              enum:
                - imports
                - uses
                - configures
                - extends
              description: "Dependency type"
        description: "Component dependency relationships"

  workflow_configuration:
    type: object
    description: "Workflow execution settings"
    additionalProperties: false
    properties:
      execution_mode:
        type: string
        enum:
          - sequential
          - parallel
          - mixed
        default: sequential
        description: "How actions should be executed"

      requires_approval:
        type: boolean
        default: false
        description: "Whether human approval is required"

      approval_threshold:
        type: string
        enum:
          - LOW
          - MEDIUM
          - HIGH
          - CRITICAL
        default: HIGH
        description: "Risk level that triggers approval requirement"

      timeout_seconds:
        type: integer
        minimum: 60
        maximum: 3600
        default: 300
        description: "Maximum execution time"

      notification_on_completion:
        type: boolean
        default: true
        description: "Send notification when task completes"

      retry_policy:
        type: object
        additionalProperties: false
        properties:
          enabled:
            type: boolean
            default: true
          max_retries:
            type: integer
            minimum: 0
            maximum: 5
            default: 3
          backoff_multiplier:
            type: number
            minimum: 1
            maximum: 5
            default: 2
          initial_delay_ms:
            type: integer
            minimum: 100
            maximum: 10000
            default: 1000

  execution_constraints:
    type: object
    description: "Constraints on execution"
    additionalProperties: false
    properties:
      max_files_modified:
        type: integer
        minimum: 1
        maximum: 100
        default: 10
        description: "Maximum files that can be modified"

      allowed_operations:
        type: array
        items:
          type: string
          enum:
            - CREATE
            - MODIFY
            - DELETE
            - RENAME
        default:
          - MODIFY
        description: "Allowed file operations"

      forbidden_patterns:
        type: array
        items:
          type: string
        default:
          - "**/.git/**"
          - "**/node_modules/**"
          - "**/__pycache__/**"
          - "**/.venv/**"
          - "**/dist/**"
          - "**/build/**"
        description: "Glob patterns for forbidden paths"

      protected_files:
        type: array
        items:
          type: string
        default:
          - "agents/logic/rules/agent_rules.md"
          - ".pre-commit-config.yaml"
          - "requirements.txt"
          - ".gitignore"
        description: "Files requiring elevated approval"

      max_file_size_bytes:
        type: integer
        minimum: 1024
        maximum: 52428800
        default: 10485760
        description: "Maximum file size in bytes (default 10MB)"

  tool_selection_policies:
    type: object
    description: "Policies for tool selection"
    additionalProperties: false
    properties:
      preferred_tools:
        type: array
        items:
          type: object
          required:
            - operation
            - tool
          additionalProperties: false
          properties:
            operation:
              type: string
              description: "Operation type"
            tool:
              type: string
              description: "Preferred tool name"
            reason:
              type: string
              description: "Reason for preference"
        description: "Preferred tools for operations"

      fallback_tools:
        type: array
        items:
          type: object
          required:
            - primary
            - fallback
          additionalProperties: false
          properties:
            primary:
              type: string
              description: "Primary tool"
            fallback:
              type: string
              description: "Fallback tool"
            condition:
              type: string
              description: "When to use fallback"
        description: "Fallback tool configurations"

  validation_rules:
    type: object
    description: "Post-execution validation rules"
    additionalProperties: false
    properties:
      verify_file_hashes:
        type: boolean
        default: true
        description: "Verify file hashes after modification"

      run_syntax_check:
        type: boolean
        default: true
        description: "Run syntax validation on modified files"

      run_schema_validation:
        type: boolean
        default: true
        description: "Validate JSON/YAML against schemas"

      custom_validators:
        type: array
        items:
          type: object
          required:
            - name
            - command
          additionalProperties: false
          properties:
            name:
              type: string
              description: "Validator name"
            command:
              type: string
              description: "Command to run"
            on_failure:
              type: string
              enum:
                - warn
                - error
                - rollback
              default: warn
              description: "Action on failure"
        description: "Custom validation commands"

  pipeline_data_contract:
    type: object
    description: "Optional pipeline data governance contract (recommended for ETL/pipeline tasks)"
    additionalProperties: false
    properties:
      environment:
        type: string
        enum: [dev, test, prod]
        description: "Runtime environment for data path policy"

      source_root:
        type: string
        minLength: 1
        description: "Root directory for immutable source inputs"

      output_root:
        type: string
        minLength: 1
        description: "Root directory for generated artifacts"

      require_external_data_root_in_prod:
        type: boolean
        default: true
        description: "If true, production source/output roots must be outside project_root"

      require_source_output_separation:
        type: boolean
        default: true
        description: "If true, source_root and output_root must differ"

      require_stage_materialization:
        type: boolean
        default: true
        description: "If true, each pipeline stage must write artifacts to disk"

      require_final_layer_from_materialized_inputs:
        type: boolean
        default: true
        description: "If true, final reports must consume persisted artifacts from previous stages"

      output_artifact_formats:
        type: array
        description: "Per-artifact format declaration (format is use-case dependent)"
        items:
          type: object
          required: [artifact_id, format]
          additionalProperties: false
          properties:
            artifact_id:
              type: string
              minLength: 1
            format:
              type: string
              minLength: 1
              description: "Examples: parquet, csv, json, xlsx"
            justification:
              type: string
              description: "Reason for chosen format"

